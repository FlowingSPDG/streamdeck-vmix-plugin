<head>
  <meta charset="utf-8" />
  <title>vMix Plugin</title>
  <script src="common.js"></script>
  <link rel="stylesheet" href="./sdpi.css">
</head>

<body>
  <!-- Wrapper starts from here... -->
  <div class="sdpi-wrapper">
    
    <!-- vMix Function name field(e.g. "Cut"). variable:FunctionName -->
    <div class="sdpi-item">
      <div class="sdpi-item-label">Function Name</div>
      <input class="sdpi-item-value" id="functionName" onchange="onFunctionNameChange()">
    </div>
    
    <!-- Inputs List. First element should be empty -->
    <div type="list" class="sdpi-item list" id="inputsList">
      <div class="sdpi-item-label">Inputs List</div>
      <div class="sdpi-item-value single-select" id="orderedList" type="">
        <!-- Input list... -->
      </div>
    </div>

    <!-- Selected input key(above) -->
    <div class="sdpi-item">
      <div class="sdpi-item-label">Selected</div>
      <input class="sdpi-item-value" id="selected_input" readonly>
    </div>

    <!-- Use tally -->
    <div type="checkbox" class="sdpi-item">
      <div class="sdpi-item-label">Tally</div>
      <input class="sdpi-item-value" id="tally_check" type="checkbox" value="left" onchange="onEnableTallyChange()">
      <label for="tally_check"><span></span>Enable tally</label>
  </div>

    <!-- Save -->
    <div class="sdpi-item">
      <div class="sdpi-item-label">Save</div>
      <button class="sdpi-item-value" id="button_save" onclick="saveSettings()">Click to save</button>
    </div>

    <script>
      // vMix variable definitions
      var vMix = {
        functionName: "PreviewInput", // Function Name
        functionInput: "", // Function Input
        queries: [], // Function query
        inputs: [], // Inputs global variable. This can be button setting
        tally: 0,
        use_tally: true,
      }
      
      var pluginAction = null,
        uuid = '',
        context = "";

      if ($SD) {
        $SD.on('connected', function (jsonObj) {
          init()
          console.log("connected")
          console.log(jsonObj)
          uuid = jsonObj['uuid'];
          if (jsonObj.hasOwnProperty('actionInfo')) {
            pluginAction = jsonObj.actionInfo['action'];
            context = jsonObj.actionInfo['context'];

            if (jsonObj.actionInfo.payload.hasOwnProperty("settings")){
              // Input
              if(jsonObj.actionInfo.payload.settings.functionInput != "") {
                vMix.functionInput = jsonObj.actionInfo.payload.settings.functionInput
              }
              if(!vMix.functionInput){ // avoid undefined
                vMix.functionInput = "0"
              }

              if(jsonObj.actionInfo.payload.settings.tally) {
                vMix.tally = jsonObj.actionInfo.payload.settings.tally
              }

              if(jsonObj.actionInfo.payload.settings.use_tally) {
                vMix.use_tally = jsonObj.actionInfo.payload.settings.use_tally
              }

              // functionName
              if(jsonObj.actionInfo.payload.settings.functionName != "" && typeof(jsonObj.actionInfo.payload.settings.functionName) == "string") {
                vMix.functionName ? jsonObj.actionInfo.payload.settings.functionName : "PreviewInput"
              }

              // Inputs
              if(Array.isArray(jsonObj.actionInfo.payload.settings.inputs)){
                vMix.inputs = jsonObj.actionInfo.payload.settings.inputs
                InputsToList()
                highlightSelected()
              }

              if(Array.isArray(jsonObj.actionInfo.payload.settings.queries)){
                vMix.queries = jsonObj.actionInfo.payload.settings.queries
              }
            }
            updateElements()
          }
        });

        $SD.on("sendToPropertyInspector", function (jsonObj) {
          console.log("sendToPropertyInspector", jsonObj)
          if(!jsonObj.payload){
            return
          }
          if(jsonObj.event == "sendToPropertyInspector"){
            if(vMix.inputs.length != jsonObj.payload.inputs.length){
              vMix.inputs = jsonObj.payload.inputs
              updateElements()
              InputsToList()
              highlightSelected()
            }
          }
          else if(jsonObj.event == "didReceiveSettings"){
            console.log("didReceiveSettings", jsonObj.payload)
          }
        })


        $SD.on("didReceiveGlobalSettings", function (jsonObj) {
          console.log("didReceiveGlobalSettings")
        })
      };
      
      function init(){
        InputsToList()
      }
      
      function unSelectList(){
        var children = document.getElementById('orderedList').children
        for(let i=0;i<children.length;i++){
          children[i].className="" // remove "selected" class
        }
      }

      function highlightSelected(){
        var children = document.getElementById('orderedList').children
        for(let i=0;i<children.length;i++){
          console.log("current Input key :",vMix.functionInput)
          const key = children[i].getAttribute("key")
          console.log("key for this input :",key)
          if(key == vMix.functionInput){
            children[i].className="selected"
          } else {
            children[i].className="" // remove "selected" class
          }
        }
      }
      
      function InputsToList(){
        const list = document.getElementById('orderedList')
        // Remove children nodes
        const clone = list.cloneNode( false ); 
        list.parentNode.replaceChild( clone , list );

        // PRV
        const PREV_id = `input_list_PRV`
        let PrevEl = document.createElement('li');
        PrevEl.textContent = `Preview`
        PrevEl.setAttribute("onclick",`onListInputClick("0");unSelectList();document.getElementById('${PREV_id}').className = "selected";document.getElementById('selected_input').value = "PRV"`) // fuck
        PrevEl.setAttribute("id",PREV_id)
        PrevEl.setAttribute("key",PREV_id)
        clone.appendChild(PrevEl);

        // PGM
        const PGM_id = `input_list_PGM`
        let PgmEl = document.createElement('li');
        PgmEl.textContent = `Program`
        PgmEl.setAttribute("onclick",`onListInputClick("-1");unSelectList();document.getElementById('${PGM_id}').className = "selected";document.getElementById('selected_input').value = "PGM"`) // fuck
        PgmEl.setAttribute("id",PGM_id)
        PgmEl.setAttribute("key",PGM_id)
        clone.appendChild(PgmEl);
        
        for (var i =0; i < vMix.inputs.length; i++) {
          if(!vMix.inputs[i]){
            continue // continue loop if inputs[i] is null
          }
          const id = `input_list_${i}`
          var li = document.createElement('li');
          li.textContent = `${vMix.inputs[i].Number} : ${vMix.inputs[i].Name}`
          li.setAttribute("onclick",`onListInputClick("${vMix.inputs[i].Key}");unSelectList();document.getElementById('${id}').className = "selected";document.getElementById('selected_input').value = "${vMix.inputs[i].Key}"`) // fuck
          li.setAttribute("id",id)
          li.setAttribute("key",vMix.inputs[i].Key)
          clone.appendChild(li);
        }
      }
            
      function onFunctionNameChange() {
        vMix.functionName = document.getElementById('functionName').value
      }

      function onEnableTallyChange() {
        vMix.use_tally = document.getElementById('tally_check').value
      }

      function onListInputClick(inputKey){
        console.log(`onListInputClick : ${inputKey}`)
        vMix.functionInput = inputKey
      }

      // update HTML elements according to "vMix" object
      function updateElements(){
        console.log("updateElements")
        document.getElementById('functionName').value = vMix.functionName
        document.getElementById('selected_input').value = vMix.functionInput
        document.getElementById('tally_check').value = vMix.use_tally
      }

      function saveSettings(){
        console.log("Saving setting",vMix)
        if ($SD && $SD.connection){
          $SD.api.sendToPlugin(uuid,pluginAction,{
           "functionInput":vMix.functionInput,
            "functionName": vMix.functionName,
            "queries":vMix.queries,
            "use_tally":vMix.use_tally,
          })
        }
      }

      function getSettings(){
        console.log("Getting setting")
        if ($SD && $SD.connection){
          $SD.api.getSettings(context)
        }
      }
    </script>
  </body>