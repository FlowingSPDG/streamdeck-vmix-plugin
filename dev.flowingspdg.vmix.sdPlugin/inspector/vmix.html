<head>
  <meta charset="utf-8" />
  <title>vMix Plugin</title>
  <script src="common.js"></script>
  <link rel="stylesheet" href="./sdpi.css">
</head>

<body>
  <!-- Wrapper starts from here... -->
  <div class="sdpi-wrapper">
    
    <!-- vMix API URL. variable:vmixAPIURL -->
    <div class="sdpi-item">
      <div class="sdpi-item-label">vMix API URL</div>
      <input class="sdpi-item-value" id="vmixAPIURL" value="http://localhost:8088/api" onchange="onAPIURLChange()">
    </div>
    
    <!-- vMix Function name field(e.g. "Cut"). variable:FunctionName -->
    <div class="sdpi-item">
      <div class="sdpi-item-label">Function Name</div>
      <input class="sdpi-item-value" id="functionName" value="Cut" onchange="onFunctionNameChange()">
    </div>
    
    <!-- Refresh inputs button -->
    <div class="sdpi-item">
      <button class="sdpi-item-value" onclick="refreshInputs()">Refresh Inputs list</button>
    </div>
    
    <!-- Inputs List. First element should be empty -->
    <div type="list" class="sdpi-item list" id="inputsList">
      <div class="sdpi-item-label">Inputs List</div>
      <div class="sdpi-item-value single-select" id="orderedList" type="">
        <!-- Input list... -->
      </div>
    </div>

    <!-- Selected input key(above) -->
    <div class="sdpi-item">
      <div class="sdpi-item-label">Selected</div>
      <input class="sdpi-item-value" id="selected_input" readonly>
    </div>
    
    <!-- Generated API URL to Copy -->
    <div class="sdpi-item">
      <div class="sdpi-item-label">Generated</div>
      <input class="sdpi-item-value" id="generated" readonly>
    </div>
    
    <!-- Coppy button -->
    <div class="sdpi-item">
      <button class="sdpi-item-value" id="button_copy" onclick="onCopy(document.getElementById('generated').value)">Copy URL</button>
    </div>
    
    <script>
      // vMix variable definitions
      var vMix = {
        vmixAPIURL: "http://localhost:8088/api", // vMix API URL
        functionName: "Cut", // Function Name
        functionInput: "", // Function Input
        queries: [], // Function query
        inputs: [null], // Inputs global variable. This can be button setting
      }
      
      var pluginAction = null,
        uuid = '';

      if ($SD) {
        $SD.on('connected', function (jsonObj) {
          init()
          uuid = jsonObj['uuid'];
          if (jsonObj.hasOwnProperty('actionInfo')) {
            pluginAction = jsonObj.actionInfo['action'];
          }
        });
        $SD.on("sendToPropertyInspector", function (jsonObj) {
          console.log("sendToPropertyInspector")
          console.log(jsonObj)
          /*
          if(!jsonObj.payload){
            return
          }
          vMix = jsonObj.payload
          updateElements()
          */
        })
        $SD.on("didReceiveSettings ", function (jsonObj) {
          console.log("didReceiveSettings")
          console.log(jsonObj)
        })
      };
      
      function init(){
        refreshInputs()
        InputsToList()
      }
      
      function refreshInputs() {
      }
      
      function unSelectList(){
        var children = document.getElementById('orderedList').children
        for(let i=0;i<children.length;i++){
          children[i].className="" // remove "selected" class
        }
      }
      
      function InputsToList(){
        const list = document.getElementById('orderedList')
        // Remove children nodes
        const clone = list.cloneNode( false ); 
        list.parentNode.replaceChild( clone , list );
        
        for (var i =0; i < vMix.inputs.length; i++) {
          if(!vMix.inputs[i]){
            continue // continue loop if inputs[i] is null
          }
          const id = `input_list_${i}`
          var li = document.createElement('li');
          li.textContent = `${vMix.inputs[i].number} : ${vMix.inputs[i].shortTitle}`
          li.setAttribute("onclick",`onListInputClick("${vMix.inputs[i].key}");applyFunctionURL();unSelectList();document.getElementById('${id}').className = "selected";document.getElementById('selected_input').value = "${vMix.inputs[i].key}"`) // fuck
          li.setAttribute("id",id)
          // li.className = "selected"
          clone.appendChild(li);
        }
      }
      
      // send Function to vMix API
      function sendFunction(name,queries) {
        // TODO...
      }
      
      function onCopy(str) {
        if(navigator.clipboard){
          navigator.clipboard.writeText(str);
        }
      }
      
      function onAPIURLChange() {
      }
      
      function onFunctionNameChange() {
      }
      
      function onListInputClick(inputKey){
        console.log(`onListInputClick : ${inputKey}`)
        vMix.functionInput = inputKey
      }
      
      function refreshURL(){
        console.log("refreshURL")
        vMix.vmixAPIURL = document.getElementById('vmixAPIURL').value
        console.log(`vmixAPIURL:${vMix.vmixAPIURL}`)
        
        vMix.functionName = document.getElementById('functionName').value
        console.log(`functionName:${vMix.functionName}`)
        console.log(`functionInput:${vMix.functionInput}`)
      }
      
      // notify action instance
      function updatevMix(){
        console.log("updatevMix")
        $SD.api.sendToPlugin(uuid, pluginAction, vMix);
      }

      // update HTML elements according to "vMix" object
      function updateElements(){
        console.log("updateElements")
        document.getElementById('vmixAPIURL').value = vMix.vmixAPIURL
        document.getElementById('functionName').value = vMix.functionName
        document.getElementById('selected_input').value = vMix.functionInput
      }
    </script>
  </body>